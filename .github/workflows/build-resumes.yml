name: Build Resume PDFs from LaTeX

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to checkout'
        required: true
        default: 'main'
      commit_id:
        description: 'Commit ID (SHA) to checkout (optional - uses latest if empty)'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Determine checkout ref
      id: determine_ref
      run: |
        if [ -n "${{ github.event.inputs.commit_id }}" ]; then
          echo "ref=${{ github.event.inputs.commit_id }}" >> $GITHUB_OUTPUT
        else
          echo "ref=${{ github.event.inputs.branch }}" >> $GITHUB_OUTPUT
        fi
    
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ steps.determine_ref.outputs.ref }}
    
    - name: Cache LaTeX dependencies
      id: cache-latex
      uses: actions/cache@v3
      with:
        path: |
          /var/cache/apt/archives
          /usr/share/texlive
        key: ${{ runner.os }}-latex-${{ hashFiles('.github/workflows/build-resumes.yml') }}
        restore-keys: |
          ${{ runner.os }}-latex-
    
    - name: Install LaTeX dependencies
      if: steps.cache-latex.outputs.cache-hit != 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          texlive-latex-base \
          texlive-latex-extra \
          texlive-fonts-recommended \
          texlive-fonts-extra
        
    - name: Build General resume
      run: |
        cd General
        mkdir -p .tmp general-resume-rendered-archive
        pdflatex -interaction=nonstopmode -output-directory=.tmp main.tex
        cp .tmp/main.pdf general-resume-rendered-archive/kausik-general-$(date +%Y-%m-%d).pdf
        
    - name: Build Backend resume
      run: |
        cd Backend
        mkdir -p .tmp backend-resume-rendered-archive
        pdflatex -interaction=nonstopmode -output-directory=.tmp main.tex
        cp .tmp/main.pdf backend-resume-rendered-archive/kausik-backend-$(date +%Y-%m-%d).pdf
        
    - name: Build MLE resume
      run: |
        cd MLE
        mkdir -p .tmp mle-resume-rendered-archive
        pdflatex -interaction=nonstopmode -output-directory=.tmp main.tex
        cp .tmp/main.pdf mle-resume-rendered-archive/kausik-mle-$(date +%Y-%m-%d).pdf
        
    - name: Build Infra resume
      run: |
        cd Infra
        mkdir -p .tmp infra-resume-rendered-archive
        pdflatex -interaction=nonstopmode -output-directory=.tmp main.tex
        cp .tmp/main.pdf infra-resume-rendered-archive/kausik-infra-$(date +%Y-%m-%d).pdf
        
    - name: Build Experiment resume
      run: |
        cd Experiment
        mkdir -p .tmp experiment-resume-rendered-archive
        pdflatex -interaction=nonstopmode -output-directory=.tmp main.tex
        cp .tmp/main.pdf experiment-resume-rendered-archive/kausik-experiment-$(date +%Y-%m-%d).pdf
      
    - name: Upload General resume artifact
      uses: actions/upload-artifact@v4
      with:
        name: kausik-general-resume
        path: General/general-resume-rendered-archive/*.pdf
        
    - name: Upload Backend resume artifact
      uses: actions/upload-artifact@v4
      with:
        name: kausik-backend-resume
        path: Backend/backend-resume-rendered-archive/*.pdf
        
    - name: Upload MLE resume artifact
      uses: actions/upload-artifact@v4
      with:
        name: kausik-mle-resume
        path: MLE/mle-resume-rendered-archive/*.pdf
        
    - name: Upload Infra resume artifact
      uses: actions/upload-artifact@v4
      with:
        name: kausik-infra-resume
        path: Infra/infra-resume-rendered-archive/*.pdf
        
    - name: Upload Experiment resume artifact
      uses: actions/upload-artifact@v4
      with:
        name: kausik-experiment-resume
        path: Experiment/experiment-resume-rendered-archive/*.pdf
